<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
      <meta charset="utf-8">
      <title>CDTO-09</title>

      <!-- CSS -->
      <link href="css/styles.css" rel="stylesheet" type="text/css">

  </head>
  <body>

  <div class="container">
      <div class="header">
          <h1>Oh Hey we got some stuff there!!</h1>
      </div>
      <div class="main"></div>
      <div id="footer"></div>
  </div>

  <!-- sockets -->
  <script src="./js/primus.js" type="text/javascript"></script>
  <!-- midi.js package -->
   <script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
   <script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
   <script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
   <script src="./js/MIDI/Player.js" type="text/javascript"></script>
   <script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
   <!-- extras -->
   <script src="./inc/Base64.js" type="text/javascript"></script>
   <script src="./inc/base64binary.js" type="text/javascript"></script>
   <!-- jquery -->
  <script src="//code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>


   <script type="text/javascript">

    var pianoNote = 50 //MIDI.pianoKeyOffset ??
    , velocity = 128;

    var operatorFunction = {
      '+' : function(operand1, operand2){
        return operand1 + operand2;
      },
      '-' : function(operand1, operand2){
        return operand1 - operand2;
      }
    }

   function changeFieldValue(fieldKey, operator, amount){
      switch(fieldKey){ //extensible
        case 'pn':
          pianoNote = operatorFunction[operator](pianoNote, amount);
          break;
        case 'v':
          velocity = operatorFunction[operator](velocity, amount);
          break;
      };
   };

    //NOISEY TINGZ!!! 
    $(document).ready(function(){
      
      MIDI.loadPlugin({
        soundfontUrl: "./soundfont/",
        instruments: [ "acoustic_grand_piano", "synth_drum" ],
        callback: function() {
          for( var i = 0; i < 100; i++){
            
            //mother f. the loop runs too quickly for our var changes!
            //uncomment and watch the console.
            //console.log('iteration %d: note=%d velocity=%d', i, pianoNote, velocity);
            
            var delay = i;
            MIDI.programChange(0, 0);
            MIDI.programChange(1, 118);
                    
            MIDI.setVolume(0, 127);
            MIDI.noteOn(0, pianoNote, velocity, delay);
            MIDI.noteOn(1, 50, 127, delay);
            MIDI.noteOn(1, 50, 64, delay + 0.5);
          }
        }
      });

      //Socket stuff
      var primus = Primus.connect('http://localhost:8080');
      primus.on('open', function () {
        primus.send('noise maker join', function(){
          console.log('successfully joined noisemaker room!');
        }); //can have callback

        primus.on('hit note harder', function(){
          changeFieldValue('v', '+', 10);
          console.log("velocity increased to: " + velocity);
        });

        primus.on('hit note softer', function(){
          changeFieldValue('v', '-', 10);
          console.log("velocity decreased to: " + velocity);
        });

        primus.on('increase note', function(){
          changeFieldValue('pn', '+', 1);
          console.log("piano note increased to " + pianoNote);
        });

        primus.on('decrease note', function(){
          changeFieldValue('pn', '-', 1);
          console.log("piano note decreased to " + pianoNote);
        });
      });
    });

  </script>

  </body>
</html>
